# Интенет-магазин на 1С-Битрикс: Управление сайтом

[1С-Битрикс: Управление сайтом](https://ru.wikipedia.org/wiki/1%D0%A1-%D0%91%D0%B8%D1%82%D1%80%D0%B8%D0%BA%D1%81:_%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%81%D0%B0%D0%B9%D1%82%D0%BE%D0%BC) является CMS (системой управления контентом веб-проекта) от компании 1С-Битрикс. С его помощью вы можете создать интернет-магазин, корпоративный сайт или новостной портал и достаточно просто управлять структурой и содержимым вашего сайта.

В этой инструкции вы научитесь разворачивать и настраивать 1С-Битрикс и необходимые для него сервисы в инфраструктуре Яндекс.Облака.

Используемые ресурсы для правильной работы 1С-Битрикс:
* Виртуальная машина с доступом во внешнюю сеть, на которой будет установлен 1С-Битрикс.
* Кластер MySQL, являющийся базой данных для 1С-Битрикс.

Чтобы развернуть и настроить 1С-Битрикс:
1. [Подготовьте облако к работе](#before-begin)
1. [Создайте виртуальную машину в облаке](#create-vm)
1. [Создайте кластер баз данных MySQL](#create-mysql)
1. [Настройте сервер для работы с 1C-Битрикс](#configure-server)
1. [Настройте 1С-Битрикс](#configure-bitrix)


## Подготовьте облако к работе {#before-begin}

Перед тем, как разворачивать сервер, нужно зарегистрироваться в Облаке и создать платежный аккаунт:

{% include [prepare-register-billing](../_solutions_includes/prepare-register-billing.md) %}

Если у вас есть активный платежный аккаунт, вы можете создать или выбрать каталог, в котором будет работать ваша виртуальная машина. Перейдите на [страницу облака](https://console.cloud.yandex.ru/cloud) и выберите или создайте каталог, в котором вы хотите создать ВМ для вашего сервера. [Подробнее об иерархии ресурсов Облака](../../resource-manager/concepts/resources-hierarchy.md).


### Необходимые платные ресурсы

В стоимость поддержки сервера для 1С-Битрикс и базы данных входит:

* плата за постоянно запущенную виртуальную машину (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));
* плата за использование динамического или статического внешнего IP-адреса (см. [тарифы {{ vpc-full-name }}](../../vpc/pricing.md));
* плата за использование управляемой базы данных (см. [тарифы {{ mmy-name }}](../../managed-mysql/pricing.md)).


## Создайте виртуальную машину в облаке {#create-vm}

Чтобы создать виртуальную машину:

1. На странице каталога в [консоли управления]({{ link-console-main }}) нажмите кнопку **Создать ресурс** и выберите пункт **Виртуальная машина**.
1. В поле **Имя** введите имя виртуальной машины. Для наглядности примера укажите `bitrix`.

   {% include [name-format](../../_includes/name-format.md) %}

1. В блоке **Публичные образы** выберите образ операционной системы Ubuntu 18.04 lts.
1. В блоке **Диски** выберите жесткий диск HDD размером 13 Гб.
1. В блоке **Вычислительные ресурсы**:
   - Выберите [платформу](../../compute/concepts/vm-platforms.md) виртуальной машины.
   - Укажите необходимое количество vCPU и объем RAM.
   
   Для корректной работы системы 1С-Битрикс укажите конфигурацию:
   * **Платформа** - Intel Cascade Lake.
   * **Гарантированная доля vCPU** — 5%.
   * **vCPU** — 2.
   * **RAM** — 4 ГБ.

1. В блоке **Сетевые настройки** нужно выбрать сеть и подсеть, к которым нужно подключить виртуальную машину. Если нужной сети или подсети еще нет, вы можете создать их прямо на странице создания ВМ.
1. В блоке **Доступ** укажите данные для доступа к виртуальной машине:
   - В поле **Логин** введите предпочтительное имя пользователя, который будет создан на виртуальной машине. Для наглядности примера укажите ubuntu.
   - В поле **SSH-ключ** скопируйте ваш открытый SSH-ключ. Пару ключей для подключения по SSH необходимо создать самостоятельно, см. [раздел о подключении к виртуальным машинам по SSH](../../compute/operations/vm-connect/ssh.md).
   
1. Нажмите кнопку **Создать ВМ**.


## Создайте кластер баз данных MySQL {#create-mysql}

Чтобы создать кластер баз данных MySQL:

1. На странице каталога в [консоли управления]({{ link-console-main }}) нажмите кнопку **Создать ресурс** и выберите пункт **Кластер MySQL**.
1. В блоке **Класс Хоста** выберите **Тип** хоста s2.micro. Данных характеристик хватит для работы системы 1С-Битрикс.
1. В блоке **База данных** укажите **Пароль**, который будет использоваться для доступа системой 1С-Битрикс к базе данных MySQL.
1. Остальные поля оставьте без изменений.
1. Нажмите на кнопку **Создать кластер**.

Создание кластера БД может занять несколько минут.

{% note info %}

После того, как база данных развернется и перейдет в состояние **Running**, кликните на имя базы данных и в открывшемся меню слева выберите вкладку **Хосты**. Далее подведите курсор к доменному имени (например такого вида rc1b-c4pf97gj76v2ornc) и скопируйте полное доменное имя базы данных. Это значение понадобится на этапе конфигурирования системы 1С-Битрикс.

{% endnote %}


## Настройте сервер для работы с 1C-Битрикс {#configure-server}

Для настройки сервера для работы с 1С-Битрикс выполните следующие шаги:

1. Выполните вход на созданный сервер с помощью SSH

   ```bash
   $ ssh ubuntu@<публичный-IP-адрес-ВМ>
   ```

   {% note info %}

   ubuntu - имя пользователя в поле **Логин**, которое вы указывали при [создании виртуальной машины](#create-vm)

   Для того, чтобы узнать публичный IP-адрес вашей виртуальной машины на странице каталога в [консоли управления]({{ link-console-main }}):
      1. выберите блок **Compute Cloud**;
      1. Кликните по имени вашей виртуальной машины (в данном примере имя виртуальной машины - bitrix);
      1. Откроется окно с общей информацией по вашей виртуальной машине. Публичный IP-адрес вы можете найти в блоке **Сеть** в строке **Публичный IPv4**;

   {% endnote %}

1. Получите права администратора

  ```bash
  ubuntu@bitrix:~$ sudo -i
  root@bitrix:~#
  ```

1. Установите необходимое ПО

  ```bash
  root@bitrix:~# apt-get update
  root@bitrix:~# apt-get install -y apache2 libapache2-mod-php php-gd php-mbstring php-mysql
  ```

1. Перейдите в рабочий каталог проекта

   ```bash
   root@bitrix:~# cd /var/www/html/
   ```

1. Скачайте дистрибутив “1С-Битрикс: Управление сайтом”

  ```bash
  root@bitrix:/var/www/html# wget https://www.1c-bitrix.ru/download/business_encode.tar.gz
  ```

1. Распакуйте полученный архив и после этого удалите ненужные файлы

  ```bash
  root@bitrix:/var/www/html# tar -zxf business_encode.tar.gz
  root@bitrix:/var/www/html# rm -f index.html business_encode.tar.gz
  ```

1. Назначьте пользователя `www-data` владельцем рабочего каталога проекта

   ```bash
   root@bitrix:/var/www/html# chown -R www-data:www-data /var/www/html
   root@bitrix:/var/www/html# ls -l
   total 76
   drwxrwxr-x 6 www-data www-data  4096 May 15 13:50 bitrix
   -rwxrwxr-x 1 www-data www-data  1378 May 15 13:50 index.php
   -rwxrwxr-x 1 www-data www-data   150 Mar 11  2013 install.config
   -rwxrwxr-x 1 www-data www-data 30741 Apr 10 14:36 license.html
   -rwxrwxr-x 1 www-data www-data   113 Nov 20  2012 license.php
   -rwxrwxr-x 1 www-data www-data 14054 Feb  6  2017 readme.html
   -rwxrwxr-x 1 www-data www-data   112 Mar 27  2013 readme.php
   drwxrwxr-x 2 www-data www-data  4096 May 15 13:50 upload
   -rwxrwxr-x 1 www-data www-data   691 Oct 27  2009 web.config
   ```

1. Настройте параметры PHP
   В соответствии с требованиями информационной системы необходимо отредактировать следующие переменные в файле конфигурации `/etc/php/7.2/apache2/php.ini`

   |Было                        | Стало                        |
   |:---------------------------| :----------------------------|
   |short_open_tag = Off        | short_open_tag = On          |
   |display_errors = Off        | display_errors = On          |
   |memory_limit = 128M         | memory_limit = 256M          |
   |;date.timezone =            | date.timezone = Europe/Moscow|
   |;opcache.revalidate_freq=2  | opcache.revalidate_freq = 0  |
   |;mbstring.func_overload = 0 | mbstring.func_overload = 2   |
   
1. Настройте сервер Apache
   В соответствиии с требованиями информационной системы необходимо отредактировать файл конфигурации `/etc/apache2/sites-enabled/000-default.conf`, добавив в него после строки `DocumentRoot /var/www/html` следующий блок:

   ```
   <Directory /var/www/html>
     Options Indexes FollowSymLinks
     AllowOverride All
     Require all granted
   </Directory>
   ```
  
1. Перезапустите Web-сервер для того, чтобы все измененные настройки применились

   ```bash
   root@bitrix:/var/www/html# service apache2 restart
   ```

1. Серверная часть сконфигурирована для корректной работы 1С-Битрикс.


## Настройте 1С-Битрикс {#configure-bitrix}

Далее вам необходимо провести настройку самого 1С-Битрикс. Чтобы сделать это:

1. Откройте Web-интерфейс 1С-Битрикс: Управление сайтом

   Для этого в браузере перейдите по адресу `http://<публичный-IP-адрес-ВМ>/`. Должна открыться страница с приглашением установить 1С-Битрикс.
   
1. Начало установки продукта

   Вы увидите стартовый экран начала установки. На данной странице ничего делать не нужно, просто нажмите кнопку **Далее**.
   
   ![Шаг 1](../_assets/bitrix-shop/bitrix-shop1.png)

1. Лицензионное соглашение

   Ознакомьтесь с лицензионным соглашением и выберите **Я принимаю лицензионное соглашение**. Затем нажмите кнопку **Далее**.
   
   ![Шаг 2](../_assets/bitrix-shop/bitrix-shop2.png)

1. Регистрация продукта

   На этом этапе необязательно регистрировать продукт, поэтому убирите соответствующую галочку, но оставьте **Установить в кодировке UTF-8** и нажмите кнопку  **Далее**.
   
   ![Шаг 3](../_assets/bitrix-shop/bitrix-shop3.png)

1. Предварительная проверка

   В этом разделе установки система проверит, все ли верно сконфигурировано на стороне сервера. Спуститесь в самый низ страницы и нажмите кнопку **Далее**.
   
   ![Шаг 4](../_assets/bitrix-shop/bitrix-shop4.png)

1. Создание базы данных

   Заполните поле **Сервер**, указав имя базы данных "полное доменное имя" и пароль из раздела [создания базы данных](#create-mysql). Остальные поля заполните как на скриншоте. После этого нажмите кнопку **Далее**.

   ![Шаг 5](../_assets/bitrix-shop/bitrix-shop5.png)
  
1. Установка продукта

   На этом этапе будет инициализирована и заполнена необходимыми данными база данных MySQL. Дождитесь окончания процесса инициализации.
   
   ![Шаг 6](../_assets/bitrix-shop/bitrix-shop6.png)

1. Создание администратора

   В данном меню предлагается создать пользователя, который сможет вносить изменения в вашу систему. Заполните все поля в соответствии с вашими персональными данными.
   
   ![Шаг 7](../_assets/bitrix-shop/bitrix-shop7.png)
   
1. Выберите решение для установки

   На выбор предлагаются шаблоны для интерфейса системы. В данном примере выбирите **Интернет-магазин** и нажмите кнопку **Далее**.

   ![Шаг 8](../_assets/bitrix-shop/bitrix-shop8.png)

1. Выбор шаблона

   В данном меню предлагается только один шаблон для оформления, поэтому просто нажмите кнопку **Далее**.
   
   ![Шаг 9](../_assets/bitrix-shop/bitrix-shop9.png)
   
1. Выбор темы

   В данном меню предлагается цветовое оформление выбранного ранее шаблона. Выберите оформление по вкусу и нажмите кнопку **Далее**.
   
   ![Шаг 10](../_assets/bitrix-shop/bitrix-shop10.png)

1. Информация о сайте

   Заполните все поля в соответствии с требованиями к интернет-магазину и нажмите кнопку **Далее**.

   ![Шаг 11](../_assets/bitrix-shop/bitrix-shop11.png)

1. Настройка каталога. Складской учет

   В данном меню можно активировать функцию складского учета, а также выбрать в какой этап будет происходить резерв товара на складе. Активируйте данную функцию в случае необходимости и нажмите **Далее**.
   
   ![Шаг 12](../_assets/bitrix-shop/bitrix-shop12.png)
   
1. Информация о магазине

   В данном меню вы должны указать информацию о магазине. Заполните все поля в соответствии с требованиями к интернет-магазину и нажмите кнопку **Далее**.
   
   ![Шаг 13](../_assets/bitrix-shop/bitrix-shop13.png)
   
1. Типы плательщиков

   Отметьте все необходимые типы плательщиков, с которыми будет работать ваш интернет-магазин. После этого нажмите кнопку **Далее**.
   
   ![Шаг 14](../_assets/bitrix-shop/bitrix-shop14.png)
   
1. Оплата и доставка

   Выберите доступные в вашем интернет-магазине способы оплаты и доставки товаров, затем нажмите кнопку **Далее**.
   
   ![Шаг 15](../_assets/bitrix-shop/bitrix-shop15.png)
   
1. Установка решения

   Начнется установка и настройка всех компонентов системы. Дождитесь ее окончания.
   
   ![Шаг 16](../_assets/bitrix-shop/bitrix-shop16.png)
   
1. Завершение настройки

   Через некоторое время появится страница, уведомляющее о том, что система установлена и настроена. Для начала работы с интернет-магазином нажмите кнопку **Перейти на сайт**.
   
   ![Шаг 17](../_assets/bitrix-shop/bitrix-shop17.png)
   
1. Готовность к эксплуатации интернет-магазина

   Вы попали в Web-интерфейс полностью готовой для дальнейшей эксплуатации системы и находитесь в режиме редактирования содержимого.
   
   ![Шаг 18](../_assets/bitrix-shop/bitrix-shop18.png)
   
   
## Как удалить созданные ресурсы {#clear-out}

Чтобы перестать платить за развернутый сервер, достаточно удалить созданную виртуальную машину и базу данных.

Если вы зарезервировали статический публичный IP-адрес специально для этой ВМ:

1. Откройте сервис **Virtual Private Cloud** в вашем каталоге.
1. Перейдите на вкладку **IP-адреса**.
1. Найдите нужный адрес, нажмите значок ![ellipsis](../../_assets/options.svg) и выберите пункт **Удалить**. 